## 应用层的基本任务

应用层主要负责不同主机多个应用进程之间的通信和协同工作，具体而言就是精确定义应用进程间的通信规则。应用层协议种类繁多，但基本都包含以下内容：

+ 应用进程交换的报文类型，如请求和响应报文；
+ 各类报文的语法，如各字段及其详细描述；
+ 字段的语义，即包含在字段中的信息的含义；
+ 进程何时、如何发送报文，以及对报文进行响应的规则。

许多应用层协议都是基于C/S方式运行的，即便是后面要提到的P2P通信。而值得注意的是，应用层协议仅仅是应用的组成部分之一（应用程序的开发就是另外一个话题了），并且也不是所有的应用程序都有联网通信的需求。此外，同一个应用程序可能还同时支持多个应用层协议，最典型的就是电子邮件，目前常见的电子邮件应用（比如Outlook、Thunderbird等）都支持SMTP、POP3以及IMAP等协议；反过来，即便是基于同一种应用层协议也能开发出各式各样的应用软件，典型例子就是市面上常见的各种浏览器，无论是Google Chrome还是FireFox，都必须使用到HTTP/HTTPS协议。

由于应用层协议种类繁多，而且新协议也是层出不穷，限于篇幅不可能一一介绍（有些协议还是非公开专用，甚至保密），下面主要介绍公开常用的几种重要协议。

## 域名系统DNS

### 何为域名

域名（domain name）是一台主机或路由器所使用的具有**层次树状结构**的名字，在整个互联网空间中具有唯一性，比如Google搜索使用的域名`www.google.com`。域名的“域”是名字空间中一个可被管理的划分，常见的域划分有顶级域、二级域和三级域等等。一个域名都是由标号（label）序列组成，各标号之间以`.`分隔。域名中的标号<font color=red>通常由英文字母、数字或连字符`-`</font>组成，每个标号不超过63个字符（在实际场景中建议不要超过12个），完整域名不超过255个字符，并且不区分大小写。代表<font color=blue>顶级域</font>的标号位于域名<font color=blue>最右边</font>，域层级从右往左依次下降。

互联网的域名空间是一棵根在上、枝叶在下的倒置树。根没有对应的名字，根以下第一层节点就被称作顶级域名（Top Level Domain，TLD），再往下就是二级、三级和四级等层级的域名，直到该域名已经能指示出单台主机为止便停止划分。目前顶级域名共分为以下三大类：

|类型|示例说明|
|:-----:|:---------:|
|国家顶级域名nTLD/ccTLD|us表示美国，cn表示中国等，允许使用域名所在国文字作为TLD|
|通用顶级域名gTLD|com表示公司企业，org表示非营利组织，gov表示政府部门等|
|基础结构域名|infrastructure domain只有arpa一个TLD，用于反向域名解析|

在nTLD下注册的二级域名均由该国家自行确定。

使用域名的好处在于使用方便，比如Bing搜索的其中一个服务器IP地址为`202.89.233.100`，然而用户不可能也不愿意去记Bing使用的所有服务器IP地址，因此使用`www.bing.com`这个域名去访问Bing无疑是比记一堆IP地址要方便得多。而域名与IP地址间的联系，会在DNS部分进行较为详细的介绍。

>注意，域名只是一个逻辑概念，不代表计算机所在的物理地点，其形式与IP地址的形式也<font color=red>没有必然关联</font>。

### DNS作用

DNS（Domain Name System）是互联网使用的一套命名系统，依据标准为RFC 1034/1035，用来把计算机域名解析为IP地址。

DNS被设计为一个联机分布式数据库系统，并采用C/S方式，使得大多数名字都可以在本地进行解析，仅少量解析需要在互联网上通信，因此效率很高。域名到IP地址的解析，是由分布在互联网上许多运行有专门解析程序的域名服务器共同完成的，其主要过程为：当某一应用进程需要把域名解析为IP地址时，就调用解析程序，并成为DNS的一个client，把待解析的域名放在DNS请求报文中，通过<font color=red>UDP</font>发给**本地**域名服务器。本地域名服务器在查找到域名对应的IP地址后（若本地查找不到就向其他域名服务器发起请求扩大查找范围），就返回一个携带该IP地址的应答报文，应用进程拿到应答报文后就可以取出IP地址进行通信。

### 域名服务器

DNS采用划分区（zone）的方式来解决域名服务器数量过多降低运行效率的问题。所谓的区，是指一个域名服务器所负责管辖的（或有权限的）范围，从关系上来讲，“区”是“域”的**子集**。为了提高DNS查询效率，除了划分区以外，域名服务器还广泛使用高速缓存，用于存放最近的查询结果。根据域名服务器所起的作用，可以划分出四种不同类型：

1. **根域名服务器（root name server）**

根域名服务器是<font color=red>最高层次</font>，也是最重要的域名服务器。所有的根域名服务器都知道所有顶级域名服务器的域名和IP地址，如果根域名服务器全部瘫痪，那么整个互联网的DNS系统都将无法工作。鉴于根域名服务器的特殊地位，建立一个根域名服务器有许多具体要求（尤其是防御网络攻击方面），并不是随便租用一台服务器主机就能建起来，可以参阅RFC 2870。

全球各地都安装有根域名服务器，但它们只使用<font color=red>13个</font>不同IP地址的**域名**（从a.root-servers.net到m.root-servers.net），简而言之，绝大多数根域名服务器只是起到镜像同步的作用，因此确切来说全世界目前有<font color=red>13组</font>根域名服务器，分别用A到M来表示。各组根域名服务器的镜像数量和覆盖范围都各不相同。再次强调，目前全世界共有13个根域名（包括1个主根域名和12个辅根域名）和对应的13组根域名服务器，而不是某些垃圾博客和劣质科普文章所说的13台根域名服务器，仅仅依靠13台服务器根本不可能支撑起全球互联网服务。

由于根域名服务器采用了任播（anycast）技术，因此当DNS客户向某个根域名服务器的IP地址发出查询报文时，互联网上的路由器就能找到离该客户最近的一个根域名服务器，加快查询速度，使互联网资源利用更为合理。根域名服务器并不存放顶级域名服务器以下级别的域名和对应IP地址信息，因此在许多情况下只是告诉本地域名服务器下一步应当通过哪个顶级域名服务器进行查询。

2. **顶级域名服务器**

顶级域名服务器负责管理在该顶级域名服务器所注册的所有二级域名，当收到DNS查询请求时，就给出相应的回答，可能是最终结果，也有可能是下一步应当查找的域名服务器的IP地址。

3. **权限域名服务器**

权限域名服务器就是负责一个区的域名服务器。

4. **本地域名服务器（local name server）**

本地域名服务器也称默认域名服务器，是主机发出DNS查询请求获取目标域名对应IP地址的第一站（通常也是最后一站）。本地域名服务器的建立要求相对要低一些，即便是一个普通单位也可以拥有。用户在计算机上配置网络时可能会被要求设置DNS服务器，指的就是设置本地服务器。由于本地域名服务器通常距离主机较近，一般不超过几个路由器，因此查询速度非常快。

主机向本地域名服务器查询一般采用**递归**查询（recursive query），即本地域名服务器自己没有相应结果的情况下，就会<font color=red>代替主机</font>向根域名服务器继续进行查询，根域名服务器将查询委托给顶级域名服务器，顶级域名服务器再将查询委托给权限域名服务器，然后将查询结果或报错信息按原路返回给主机。

本地域名服务器向根域名服务器查询一般用**迭代**查询（iterative query），当然也可以用递归查询，这取决于查询请求报文的设置。迭代查询是指本地域名服务器在查询过程中，没有上级域名服务器层层委托转交查询请求和回答结果，而是直接让本地服务器向对应上级域名服务器查询。

两者的差别可以通过下图看出：

![](pics/dns.png)

可以看到，不管采用什么类型的查询方式，主机始终只要跟本地域名服务器打交道，这样就减少了主机的工作负担。

## 文件共享协议FTP/TFTP

文件共享协议可以分为两大类，一类是复制整个文件到本地，其含义为：若要存取一个文件，就必须先获得一个本地的文件副本。如果要修改文件，只能对文件的副本进行修改，然后再将修改后的文件副本传回原节点。像FTP和TFTP就是属于这种类型。但是<font color=red>每次都要传输一整个文件副本的做法并不总是合理的</font>，因此出现了另一类文件共享协议。

文件共享协议的另一大类是联机访问（on-line access），即允许多个程序同时对一个文件进行存取，但用户不需要使用特殊的客户进程，而是由**操作系统**提供对远地共享文件进行访问的服务，如同对本地文件的访问一样，实现了**透明存取**。常用的协议有NFS（Network File System），主要用在TCP/IP网络上，适用于UNIX和MS-Windows等系统。NFS允许应用进程打开一个远程文件，并能在该文件的某一特定位置上读写数据，用户只需要复制文件中一个很小的片段，然后通过网络传输少量修改数据即可。

### 文件传送协议FTP

FTP（File Transfer Protocol）是互联网上使用最为广泛的文件传送协议，它基于TCP，采用C/S方式运行，提供交互式的访问，允许客户指明文件的类型与格式，并允许文件具有存取权限。FTP的主要功能是减少或消除在不同操作系统下处理文件的不兼容性。

FTP的应用进程分为server和client。server可同时为多个client提供服务，并且由两部分组成：负责接收新请求的主进程，以及若干负责处理单个请求的从属进程。主进程的工作步骤为：

1. 打开端口21，使client进程能够连接上；
2. 等待client进程发出连接请求；
3. 启动从属进程处理client进程发来的请求，处理完毕即终止，可根据需要创建其他子进程；
4. 回到等待状态，继续接受其他client进程发来的请求。

>注意，主进程和从属进程的处理是并发进行的。

在进行文件传输时，FTP的client和server之间要建立两个并行的TCP连接，即用来传输传送请求的**控制连接**，以及用来传输文件数据的**数据连接**。前者在整个会话期间一直保持打开，与文件传输相分离，因此FTP的控制信息传输也被称作带外（out of band）传送。

### 简单文件传送协议TFTP

TFTP（Trivial File Transfer Protocol）是一个基于UDP的文件分享协议，它只支持文件传输而不支持交互，也不能对用户进行身份鉴别，主要在小型设备上。TFTP的主要特点有：

1. 除最后一次传送外，每次传送的数据报文中必须有512字节的数据；
2. 数据报文从1开始按序编号；
3. 支持ASCII码或二进制传送；
4. 可对文件进行读写；
5. 使用很简单的首部。

TFTP在工作时，client会向server的69端口发送请求报文，server选择一个新的端口和client进行通信。每发送完一个文件块后就等待对方的确认，确认时应指明所确认的块编号，规定时间内未收到确认就重发数据。

## 超文本传送协议HTTP

HTTP（HyperText Transfer Protocol）是万维网（World Wide Web，WWW，也称Web）的核心组成部分，它定义了浏览器如何向服务器请求文档，以及服务器如何将文档传送给浏览器，基于TCP运行。为了提高安全性，HTTP现在又加上SSL/TLS协议对传输的数据实施加密，形成了HTTPS（HTTP over Secure Socket Layer）。

>SSL是Secure Socket Layer的缩写，TLS是Transport Layer Security的缩写，后者由前者发展而来。

### Web、URL与HTML

Web是一个大规模联机式的信息存储系统，由大量站点提供分布式的超媒体（hypermedia）系统服务。超媒体是超文本的扩充，所谓超文本是指包含指向其他文档的链接的文本，仅包含文本信息，而超媒体还包括图形音像等非文本类信息。Web把大量信息分布在整个互联网上，每个站点单独管理自己的文档——也就是页面（page）——并通过链接进行访问。可以说，Web就是互联网的基石，没有Web也就不会有今天的互联网，更不会有后来以智能移动设备和App为核心的移动互联网（现在基于浏览器提供网页服务的被称作WebApp）。

之前提到，互联网各个站点通过链接（link）建立联系，所谓链接，实际上指代的是统一资源定位符URL（Uniform Resource Locator），一个在整个互联网范围内的唯一标识符。能够在互联网上可以被访问到的任何类型的对象都被称为“资源”，使用URL就可以标识这些资源在互联网上的位置以及访问方法。URL的基本格式为：`<协议>://<域名/IP地址>:<端口>/<路径>`， 目前常用的协议有HTTP和FTP。使用HTTP协议的URL可以省略端口，因为HTTP使用的是[系统端口](/ComputerNetwork/Chapter_5_运输层?id=基本概念)80。如果把路径省略，那么就默认访问的是一个站点的主页（home page）。主页是一个站点最高级别的页面，主要用来展示站点的重要信息，同时也可以提供访问其他页面或站点的链接。

HTML（HyperText Markup Language，超文本标记语言）是Web使用的一种核心技术，用于制作Web页面，截至2021年8月，最新版本为HTML 5.0。HTML文档跟普通文档的主要区别在于标签（tag）的使用，如果把`.html`文件直接改成`.txt`，原有的文本基本上都能直接读取出来，而且用于设置文本样式和资源链接的各类标签也会直接展示。HTML的标准由W3C负责制定维护，详见地址：[https://html.spec.whatwg.org/multipage/sections.html](https://html.spec.whatwg.org/multipage/sections.html)。HTML并不总是单独出现，与之配套使用的还有CSS（Cascading Style Sheets，层叠样式表），专门用于为HTML文档定义布局，比如在浏览器上显示的字体、颜色、边距、高度、宽度、背景以及图像等。HTML和CSS的主要区别是前者用于结构化内容，而后者用于格式化这些内容。

早期的Web站点都是基于HTML开发一系列静态文档（static document）进行展示，随着技术的发展又出现了由应用程序动态创建的动态文档（dynamic document），当服务器接收到浏览器请求时就运行CGI程序生成HTML文件并返回给浏览器进行展示。CGI（Common Gateway Interface，通用网关接口）是一种标准，它定义了动态文档如何被创建，输入的数据如何提供给应用程序，以及输出结果应如何使用。

为了使HTML能进一步支持活动内容（比如动画效果），又出现了一种称作“活动文档”（active document）的技术。活动文档中嵌入了Java applet（小程序），当浏览器下载该类型文档之后，用户点击页面上的区域或控件，就可以动态地改变页面上展示的内容。活动文档跟动态文档的差别在于，前者的活动内容展示需要由浏览器支持并执行，而后者需要服务器运行CGI程序。

### HTTP工作原理

HTTP是一种**面向事务**（transaction-oriented）的应用层协议，除了传送完成链接跳转所必需的信息，还传送任何可从互联网上得到的信息。基于HTTP的Web工作过程大致如下图所示：

![](pics/http.png)

HTTP基于TCP实现可靠传输，不需要考虑数据在传输过程中被丢弃后又怎样被重传。HTTP本身是<font color=red>无连接</font>的，即通信双方在交换HTTP报文之前不必先建立所谓的HTTP连接；HTTP也是<font color=red>无状态</font>（stateless）的，服务器并不知道客户是否访问过，也不知道为该客户提供过多少次服务——当然，这是在不使用Cookie等手段记录访客信息的情况下——从这一角度来看，无状态的特性可以简化服务器的设计。

HTTP目前已经更新到2.0版本，但主要在用的版本依然是HTTP/1.0和HTTP/1.1。HTTP/1.0有一个明显的缺点是采用**非持续连接**，每请求一个文档就得建立一个TCP连接，并且还要发送请求和接收文档，之后断开，这样就花费了两倍的RTT；而每次建立连接都要分配服务器资源，通信量也会随之上升，对服务端的工作负担很大。HTTP/1.1对此进行了改进，采取**持续连接**（persistent connection）方式确保只用一条TCP连接就可以传送HTTP请求报文和响应报文，减少了通信量和服务器工作负担。此外，HTTP/1.1还支持非流水线（without pipeline）和流水线（with pipeline）两种工作方式，目前普遍使用的是后一种类型。

#### HTTP报文结构

HTTP报文分为请求报文和响应报文两大类。由于HTTP是面向文本的，因此报文中的每个字段都是一些ASCII码串，各个字段长度并不固定。先来看请求报文的基本格式：

```
方法 相对URL 版本   <这是请求行>
首部字段名1: 值1    <这是首部行的第一个字段>
首部字段名2: 值2
···
                   <首部行与报文主体间必须用一行CRLF分隔>
报文主体            <报文主体可以为空>
```

请求方法和含义可以参考Mozilla的相关文档：[https://developer.mozilla.org/en-US/docs/Web/HTTP/Methods](https://developer.mozilla.org/en-US/docs/Web/HTTP/Methods)

响应报文的格式除了最开始一行，几乎与请求报文没有差别：

```
版本 状态码 状态短语    <这是响应行>
首部字段名1: 值1        <这是首部行第一个字段>
首部字段名2: 值2
···
                       <首部行与报文主体间必须用一行CRLF分隔>
报文主体                <报文主体可为空>
```

状态码和含义可以参考Mozilla相关文档：[https://developer.mozilla.org/en-US/docs/Web/HTTP/Status](https://developer.mozilla.org/en-US/docs/Web/HTTP/Status)。

利用Google Chrome的开发者工具（按F12调出），在Network选项下选择一个会话，即可查看该会话的请求和响应报文详细信息，如下图所示：

![](pics/http2.png)

#### 代理服务器

代理服务器（proxy server）是一种网络实体，负责把最近的一些请求和响应暂存在本地磁盘中，当新请求到达时，若代理服务器发现这个请求已经存在，就直接返回暂存的响应，否则就进入互联网访问该资源。使用代理服务器的好处是可以提高资源的访问速度，减少通信链路的负担，而坏处就是如果代理服务器的缓存更新不及时，那么用户的使用体验会非常糟糕，典型的反面教材就是长城宽带的缓存服务器。

#### Cookie

Cookie是一种在HTTP服务器和客户之间传递的状态信息，目前尚无标准译名。由于HTTP本身是无状态的，因此在某些需要保存状态的场景中，比如在线购物，就必须设法保存用户的状态信息，目前通用的方案就是使用Cookie。

当用户浏览某个使用Cookie的网站时，该站服务器就为用户生成并在响应报文中返回一个Cookie值（赋给首部行字段Set-cookie），同时在数据库中保存；用户浏览器收到该响应后，就会在特定Cookie文件中加入该Cookie值和对应的主机名，用户继续浏览该网站时，每发送一个请求报文，都会用这个Cookie值去设置首部行字段Cookie，这样该网站的服务器就能跟踪用户在该站的活动。但是Cookie的使用也带来了用户隐私泄露的隐患，因此市面上的浏览器也都基本支持禁用Cookie。

## 电子邮件协议SMTP/POP3/IMAP

## 动态主机配置协议DHCP

## 简单网络管理协议SNMP

## 应用间通信

### 系统接口

### P2P通信