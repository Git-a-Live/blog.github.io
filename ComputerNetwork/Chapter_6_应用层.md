## 应用层的基本任务

应用层主要负责不同主机多个应用进程之间的通信和协同工作，具体而言就是精确定义应用进程间的通信规则。应用层协议种类繁多，但基本都包含以下内容：

+ 应用进程交换的报文类型，如请求和响应报文；
+ 各类报文的语法，如各字段及其详细描述；
+ 字段的语义，即包含在字段中的信息的含义；
+ 进程何时、如何发送报文，以及对报文进行响应的规则。

许多应用层协议都是基于C/S方式运行的，即便是后面要提到的P2P通信。而值得注意的是，应用层协议仅仅是应用的组成部分之一（应用程序的开发就是另外一个话题了），并且也不是所有的应用程序都有联网通信的需求。此外，同一个应用程序可能还同时支持多个应用层协议，最典型的就是电子邮件，目前常见的电子邮件应用（比如Outlook、Thunderbird等）都支持SMTP、POP3以及IMAP等协议；反过来，即便是基于同一种应用层协议也能开发出各式各样的应用软件，典型例子就是市面上常见的各种浏览器，无论是Google Chrome还是FireFox，都必须使用到HTTP/HTTPS协议。

由于应用层协议种类繁多，而且新协议也是层出不穷，限于篇幅不可能一一介绍（有些协议还是非公开专用，甚至保密），下面主要介绍公开常用的几种重要协议。

## 域名系统DNS

### 何为域名

域名（domain name）是一台主机或路由器所使用的具有**层次树状结构**的名字，在整个互联网空间中具有唯一性，比如Google搜索使用的域名`www.google.com`。域名的“域”是名字空间中一个可被管理的划分，常见的域划分有顶级域、二级域和三级域等等。一个域名都是由标号（label）序列组成，各标号之间以`.`分隔。域名中的标号<font color=red>通常由英文字母、数字或连字符`-`</font>组成，每个标号不超过63个字符（在实际场景中建议不要超过12个），完整域名不超过255个字符，并且不区分大小写。代表<font color=blue>顶级域</font>的标号位于域名<font color=blue>最右边</font>，域层级从右往左依次下降。

互联网的域名空间是一棵根在上、枝叶在下的倒置树。根没有对应的名字，根以下第一层节点就被称作顶级域名（Top Level Domain，TLD），再往下就是二级、三级和四级等层级的域名，直到该域名已经能指示出单台主机为止便停止划分。目前顶级域名共分为以下三大类：

|类型|示例说明|
|:-----:|:---------:|
|国家顶级域名nTLD/ccTLD|us表示美国，cn表示中国等，允许使用域名所在国文字作为TLD|
|通用顶级域名gTLD|com表示公司企业，org表示非营利组织，gov表示政府部门等|
|基础结构域名|infrastructure domain只有arpa一个TLD，用于反向域名解析|

在nTLD下注册的二级域名均由该国家自行确定。

使用域名的好处在于使用方便，比如Bing搜索的其中一个服务器IP地址为`202.89.233.100`，然而用户不可能也不愿意去记Bing使用的所有服务器IP地址，因此使用`www.bing.com`这个域名去访问Bing无疑是比记一堆IP地址要方便得多。而域名与IP地址间的联系，会在DNS部分进行较为详细的介绍。

>注意，域名只是一个逻辑概念，不代表计算机所在的物理地点，其形式与IP地址的形式也<font color=red>没有必然关联</font>。

### DNS作用

DNS（Domain Name System）是互联网使用的一套命名系统，依据标准为RFC 1034/1035，用来把计算机域名解析为IP地址。

DNS被设计为一个联机分布式数据库系统，并采用C/S方式，使得大多数名字都可以在本地进行解析，仅少量解析需要在互联网上通信，因此效率很高。域名到IP地址的解析，是由分布在互联网上许多运行有专门解析程序的域名服务器共同完成的，其主要过程为：当某一应用进程需要把域名解析为IP地址时，就调用解析程序，并成为DNS的一个client，把待解析的域名放在DNS请求报文中，通过<font color=red>UDP</font>发给**本地**域名服务器。本地域名服务器在查找到域名对应的IP地址后（若本地查找不到就向其他域名服务器发起请求扩大查找范围），就返回一个携带该IP地址的应答报文，应用进程拿到应答报文后就可以取出IP地址进行通信。

### 域名服务器

DNS采用划分区（zone）的方式来解决域名服务器数量过多降低运行效率的问题。所谓的区，是指一个域名服务器所负责管辖的（或有权限的）范围，从关系上来讲，“区”是“域”的**子集**。为了提高DNS查询效率，除了划分区以外，域名服务器还广泛使用高速缓存，用于存放最近的查询结果。根据域名服务器所起的作用，可以划分出四种不同类型：

1. **根域名服务器（root name server）**

根域名服务器是<font color=red>最高层次</font>，也是最重要的域名服务器。所有的根域名服务器都知道所有顶级域名服务器的域名和IP地址，如果根域名服务器全部瘫痪，那么整个互联网的DNS系统都将无法工作。鉴于根域名服务器的特殊地位，建立一个根域名服务器有许多具体要求（尤其是防御网络攻击方面），并不是随便租用一台服务器主机就能建起来，可以参阅RFC 2870。

全球各地都安装有根域名服务器，但它们只使用<font color=red>13个</font>不同IP地址的**域名**（从a.root-servers.net到m.root-servers.net），简而言之，绝大多数根域名服务器只是起到镜像同步的作用，因此确切来说全世界目前有<font color=red>13组</font>根域名服务器，分别用A到M来表示。各组根域名服务器的镜像数量和覆盖范围都各不相同。再次强调，目前全世界共有13个根域名（包括1个主根域名和12个辅根域名）和对应的13组根域名服务器，而不是某些垃圾博客和劣质科普文章所说的13台根域名服务器，仅仅依靠13台服务器根本不可能支撑起全球互联网服务。

由于根域名服务器采用了任播（anycast）技术，因此当DNS客户向某个根域名服务器的IP地址发出查询报文时，互联网上的路由器就能找到离该客户最近的一个根域名服务器，加快查询速度，使互联网资源利用更为合理。根域名服务器并不存放顶级域名服务器以下级别的域名和对应IP地址信息，因此在许多情况下只是告诉本地域名服务器下一步应当通过哪个顶级域名服务器进行查询。

2. **顶级域名服务器**

顶级域名服务器负责管理在该顶级域名服务器所注册的所有二级域名，当收到DNS查询请求时，就给出相应的回答，可能是最终结果，也有可能是下一步应当查找的域名服务器的IP地址。

3. **权限域名服务器**

权限域名服务器就是负责一个区的域名服务器。

4. **本地域名服务器（local name server）**

本地域名服务器也称默认域名服务器，是主机发出DNS查询请求获取目标域名对应IP地址的第一站（通常也是最后一站）。本地域名服务器的建立要求相对要低一些，即便是一个普通单位也可以拥有。用户在计算机上配置网络时可能会被要求设置DNS服务器，指的就是设置本地服务器。由于本地域名服务器通常距离主机较近，一般不超过几个路由器，因此查询速度非常快。

主机向本地域名服务器查询一般采用**递归**查询（recursive query），即本地域名服务器自己没有相应结果的情况下，就会<font color=red>代替主机</font>向根域名服务器继续进行查询，根域名服务器将查询委托给顶级域名服务器，顶级域名服务器再将查询委托给权限域名服务器，然后将查询结果或报错信息按原路返回给主机。

本地域名服务器向根域名服务器查询一般用**迭代**查询（iterative query），当然也可以用递归查询，这取决于查询请求报文的设置。迭代查询是指本地域名服务器在查询过程中，没有上级域名服务器层层委托转交查询请求和回答结果，而是直接让本地服务器向对应上级域名服务器查询。

两者的差别可以通过下图看出：

![](pics/dns.png)

可以看到，不管采用什么类型的查询方式，主机始终只要跟本地域名服务器打交道，这样就减少了主机的工作负担。

## 文件共享协议FTP/TFTP

文件共享协议可以分为两大类，一类是复制整个文件到本地，其含义为：若要存取一个文件，就必须先获得一个本地的文件副本。如果要修改文件，只能对文件的副本进行修改，然后再将修改后的文件副本传回原节点。像FTP和TFTP就是属于这种类型。

文件共享协议的另一大类是联机访问（on-line access），即允许多个程序同时对一个文件进行存取，但用户不需要使用特殊的客户进程，而是由**操作系统**提供对远地共享文件进行访问的服务，如同对本地文件的访问一样，实现了**透明存取**。常用的协议有NFS（Network File System），主要用在TCP/IP网络上，适用于UNIX和MS-Windows等系统。NFS允许应用进程打开一个远程文件，并能在该文件的某一特定位置上读写数据，用户只需要复制文件中一个很小的片段，然后通过网络传输少量修改数据即可。

### 文件传送协议FTP

FTP（File Transfer Protocol）是互联网上使用最为广泛的文件传送协议，它基于TCP，采用C/S方式运行，提供交互式的访问，允许客户指明文件的类型与格式，并允许文件具有存取权限。FTP的主要功能是减少或消除在不同操作系统下处理文件的不兼容性。

FTP的应用进程分为server和client。server可同时为多个client提供服务，并且由两部分组成：负责接收新请求的主进程，以及若干负责处理单个请求的从属进程。

### 简单文件传送协议TFTP

## 远程终端协议TELNET

## 超文本传送协议HTTP/HTTPS

## 电子邮件协议SMTP/POP3/IMAP

## 动态主机配置协议DHCP

## 简单网络管理协议SNMP

## 应用间通信

### 系统接口

### P2P通信