## 运输层的任务

运输层是TCP等协议所在的重要层次，主要任务是**为相互通信的应用进程提供逻辑通信服务**。运输层是面向通信部分的最高层，同时也是用户功能中的最低层。运输层存在的主要原因是，两台主机之间的通信实际上是两台主机上的应用进程间进行通信，仅仅使用IP协议只能将数据报传输到目的主机上，而无法直接交给应用进程。

运输层具备**复用**（multiplexing）和**分用**（demultiplexing）这两个重要的功能。复用是指发送方不同的应用进程都可以使用同一个运输层协议传送数据，分用则表示接收方的运输层再剥去报文首部后能够将这些数据正确交付给目的应用进程——如果仔细研究网络层的工作过程的话，也会发现其具有类似的复用和分用功能。

在网络层中，IP协议只校验首部是否出现差错，而运输层会对数据部分进行差错检测。根据应用程序的不同需求，运输层需要有两种不同的运输协议即**面向连接的TCP**和**无连接的UDP**，前者确保可靠传输，而后者不保证。

## 基本概念

+ **面向连接**

所谓面向连接，是指在传输数据之前建立连接，传输结束后释放连接，类似于打电话。数据传输依赖于已建立的可靠连接（无论是逻辑的还是物理的），而连接建立则依赖于两进程间一系列的会话通信，比如请求确认等。通信双方必须经常地确认对方能够正常接收到正确的数据报，从而实现可靠传输。

与面向连接相对应的概念是无连接，通信双方不需要建立连接，发送方不用确认接收方是否能够正常接收到正确数据，接收方也不必向发送方反馈任何确认信息，类似于送报纸。正如报纸有可能在半路上丢失那样，无连接传输的数据在途中也是有可能因为各种原因被路由器丢弃掉的。

+ **端口**

在运输层中，“端口”一词指代的是协议端口号（protocol port number），作为一种应用层各协议进程与运输实体进行层间交互的**地址**，它跟物理层的不同硬件设备进行交互的硬件接口并不是一回事。运输层使用端口从而得以实现数据报的分用，如果不用端口，而直接使用系统进程标识符，那么就会产生问题：系统进程的创建和撤销都是动态的，通信双方几乎无法识别对方机器上的进程；不同操作系统的进程标识符格式不一，识别工作繁琐复杂。

TCP/IP运输层端口用一个16位的端口号来标志一个端口，很显然这种长度的地址是不可能像IP那样进行全球分配的，因此端口号和专用IP地址一样**只具有本地意义**，不同主机上的进程使用相同端口号并不会引起冲突。在同一主机上，端口号也是一种非共享资源，一个端口在同一时刻只能由一个进程占用，否则会发生冲突。

运输层端口主要分为两大类：

|类别|描述说明|
|:-----:|:-------------|
|服务器端用|0-1023为系统端口号，由IANA指派给TCP/IP最重要的一些应用程序，如HTTPS对应443，HTTP对应80等；1024-49151为登记端口号，使用前必须在IANA办理登记手续|
|客户端用|49152~65535又称短暂端口号，仅在客户端程序运行时由系统动态分配，进程结束后即释放资源|

## 用户数据报协议UDP

UDP（User Datagram Protocol）是一种比较简单的运输层协议，它只是在IP数据报服务基础上增加了复用、分用以及差错检测的功能，主要特点有：

1. 无连接的；
2. 尽最大努力交付；
3. 面向报文，一次交付一个**完整**报文，无论长短均不合并不拆分；
4. 无拥塞控制，即便网络拥塞也不会改变发送速率；
5. 支持一对一、一对多、多对一和多对多的交互通信；
6. 开销小，首部只有8个字节。

UDP报文只有首部和数据两个部分，首部由以下字段构成：

|字段|长度/字节|描述说明|
|:-----:|:-----:|:----------|
|源端口|2|发送该报文的端口号，不需要对方回信时全部置0|
|目的端口|2|接收该报文的端口|
|长度|2|包含首部在内的报文长度，最小值为8|
|检验和|2|监测报文在传输过程中是否有错，有错就丢弃|

UDP校验过程如下：

1. 发送方将检验和字段全部置0；
2. 添加12字节伪首部；
3. 若UDP数据部分非偶数字节，则以一个全0字节补齐；
4. 将上述步骤所得内容按16位划分，并对这些16位字之和进行二进制反码计算，结果写入校验和；
5. 接收方对收到的UDP数据报执行步骤1至步骤3，按二进制反码计算结果；
6. 若步骤5结果全为1，表明无差错，否则即为有差错，应当进行差错处理。

## 传输控制协议TCP

TCP（Tranmission Control Protocol）是TCP/IP体系中非常重要且非常复杂的一个协议，其主要特点有：

1. 面向连接；
2. 一对一、全双工通信；
3. 可靠交付；
4. 面向字节流，TCP将应用层交下来的数据仅看作无结构的字节流，并不知道字节流的含义。

TCP建立连接之后，其两端的收发双方通过**套接字**（socket）进行通信。所谓套接字，实际上就是一种`IP:port`形式的地址，每一条TCP连接**唯一**地被通信两端的两个套接字所确定。socket在不同的场景中代表不同的含义：

+ 运输层和应用层间的一种接口称为socket API，简称socket；
+ socket API当中的一个函数名是socket；
+ 调用socket函数的端点也被称为socket；
+ 调用socket函数返回的socket描述符简称socket；
+ 操作系统内核联网协议的Berkeley实现被称作socket实现。

### 常用配套协议

#### 停止等待协议

#### 连接ARQ协议

#### 滑动窗口协议

### TCP报文格式

### 工作原理

#### 可靠传输实现

#### 流量控制实现

#### 拥塞控制实现

### 运输连接管理

#### 建立连接

#### 数据传输

#### 连接释放
